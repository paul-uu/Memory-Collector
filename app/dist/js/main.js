var soundcloud_client_id="f090e42cddcc8f357aba77ef251c9148";SC.initialize({client_id:soundcloud_client_id});var months=["January","February","March","April","May","June","July","August","September","October","November","December"],days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],today=new Date,year=today.getFullYear(),month=months[today.getMonth()],date=today.getDate(),day=days[today.getDay()],hour=today.getHours(),mins=today.getMinutes(),raw=Date.now(),am_pm=hour>12?"pm":"am",time_string=(hour%12).toString()+":"+mins.toString()+" "+am_pm;!function(){function e(e,t){switch(e){case"joy":return"color"===t?"#F5F317":"happy";case"sadness":return"color"===t?"#5380be":"sad";case"anger":return"color"===t?"#db373e":"angry";case"fear":return"color"===t?"#c3648e":"scary";case"disgust":return"color"===t?"#73c557":"disgusting";case"neutral":return"color"===t?"#ddd":"neutral"}}function t(e,t,i){noty({type:e,layout:t,text:i,timeout:2e3,modal:!1,maxVisible:5,closeWith:["click"]})}var i=$(window),a=i.width(),r=i.height();i.on("resize",function(){a=i.width(),r=i.height()});var o=Backbone.Model.extend({defaults:{date_time:{year:year,month:month,date:date,day:day,time:time_string,raw:raw},memory_text:null,media:{image:null,video:null,audio:null},emotions:{joy:{value:null,percentage:null},sadness:{value:null,percentage:null},anger:{value:null,percentage:null},fear:{value:null,percentage:null},disgust:{value:null,percentage:null},neutral:{value:null,percentage:null}},gradient:{"default":null,webkit:null,moz:null}},emotion_vals_to_percentages:function(){var e=this.attributes.emotions,t=0;for(var i in e)e[i].value&&(t+=e[i].value);for(var i in e)e[i].value&&(e[i].percentage=Math.floor(e[i].value/t*100))},percentages_to_gradient_string:function(){var t,i=0,a=this.attributes.emotions,r=0,o=1,n="linear-gradient(to bottom, ";for(var s in a)a[s].percentage&&r++;if(1===r)for(s in a)if(a[s].percentage)return void(this.attributes.gradient["default"]=e(s,"color"));for(s in a)a[s].percentage&&(o===r?t=");":(i+=a[s].percentage,t=i+"%, "),n+=e(s,"color")+" "+t,o++);this.attributes.gradient["default"]=n}}),n=Backbone.Collection.extend({model:o,localStorage:new Backbone.LocalStorage("Memory_LocalStorage"),comparator:function(e,t){return e.get("date_time").raw<t.get("date_time").raw?-1:1},greaterThan:function(e){var t=this.filter(function(t){return t.get("emotions")[e].percentage>0});return new n(t)}}),s=new n,l=new n;s.fetch(),l.fetch();var d=Backbone.View.extend({el:$("#control_panel"),events:{"click #add_memory":"add_memory","change #sort_select":"collection_sort","change #filter_select":"filter_by"},initialize:function(){this.render()},render:function(){},add_memory:function(){u.render()},collection_sort:function(e){var t=$(e.currentTarget).val();"newest"===t||"oldest"===t?f.sort_by_date(t):f.sort_by_emotion(t)},filter_by:function(e){var t=$(e.currentTarget).val();f.filter_by_emotion(t)}}),m=(new d,Backbone.View.extend({el:$("#add_memory_dialog"),events:{"click #modal_cancel":"close","click .modal_close":"close","click .input_attachment_icon":"toggle_attachment","click #modal_reset":"reset","click #save_new_memory":"save_memory","click .add_attachment_url":"add_attachment","keyup #input_memory":function(){this.validate(),this.new_memory.attributes.memory_text=$("#input_memory").val()}},initialize:function(){var e=this;e.new_memory=null,e.initialize_new_memory(),autosize($("#input_memory")),$(".emotion_slider").slider({change:function(t,i){e.validate(t,i);var a=$(t.target).attr("id"),r=a.substring(a.indexOf("_")+1,a.length);e.new_memory.attributes.emotions[r].value=i.value},range:"min",value:0,min:0,max:5})},render:function(){this.$el.addClass("view"),$(".input_attachment_icon").removeClass("active"),$("#input_memory").focus()},render_model_data:function(){var e=this.new_memory.attributes;$("#input_memory").val(e.memory_text);for(emotion in e.emotions)this.render_emotion_slider(emotion,e.emotions[emotion].value);for(attachment in e.media)this.render_attachment_status(attachment,e.media[attachment])},render_emotion_slider:function(e,t){$("#slider_"+e).slider("value",t)},render_attachment_status:function(e,t){switch(e){case"audio":var i=$("#attachment_button_audio > .attachment_check");t?i.removeClass("hide"):i.addClass("hide");break;case"image":var i=$("#attachment_button_image > .attachment_check");t?i.removeClass("hide"):i.addClass("hide");break;case"video":var i=$("#attachment_button_video > .attachment_check");t?i.removeClass("hide"):i.addClass("hide")}},clear:function(){$("#input_memory").val(""),$(".emotion_slider").slider("value",0)},close:function(){this.$el.removeClass("view")},toggle_attachment:function(e){var t=$(e.target).closest(".input_attachment_icon"),i=t.attr("data-attachment-type");t.toggleClass("active").siblings().removeClass("active"),t.hasClass("active")?this.toggle_attachment_input(i):this.toggle_attachment_input(!1)},toggle_attachment_input:function(e){var t=$('.attachments_input[data-attachment-type="'+e+'"]');if($(".attachments_input").addClass("hide"),e)switch(e){case"audio":t.removeClass("hide"),$("#audio_text_input").val(this.new_memory.attributes.media.audio);break;case"image":t.removeClass("hide"),$("#image_text_input").val(this.new_memory.attributes.media.image);break;case"video":t.removeClass("hide"),$("#video_text_input").val(this.new_memory.attributes.media.video);break;default:console.log("error - toggle_attachment_input")}else t.html("")},validate:function(e,t){var i=this;if(!$("#input_memory").val())return void i.handle_save_button("disable");var a=!1;this.$el.find(".emotion_slider").each(function(e,t){return $(this).slider("value")>0?void(a=!0):void 0}).promise().done(function(){return a?void i.handle_save_button("enable"):void i.handle_save_button("disable")})},handle_save_button:function(e){"enable"===e?$("#save_new_memory").addClass("enabled"):"disable"===e&&$("#save_new_memory").removeClass("enabled")},add_attachment:function(e){var i=$(e.target).attr("data-attachment-type"),a=$("#"+i+"_text_input").val();if(a=$.trim(a),""===a)return this.new_memory.attributes.media[i]=a,void this.render_model_data();if(this.validate_url(a))switch(i){case"audio":if(this.validate_audio_url(a))return this.new_memory.attributes.media.audio=a,void this.render_model_data();t("warning","topCenter","Please enter an accepted audio/music website url");break;case"image":if(this.validate_image_url(a))return this.new_memory.attributes.media.image=a,void this.render_model_data();alert("Please enter on of the accepted audio/music based website urls:\nSoundcloud, Bandcamp, Youtube");break;case"video":if(this.validate_video_url(a))return this.new_memory.attributes.media.video=a,void this.render_model_data();alert("Please enter on of the accepted audio/music based website urls:\nSoundcloud, Bandcamp, Youtube")}else alert("Please enter a valid url\nex: https://google.com")},add_image_attachment:function(){var e=$("#image_text_input").val();this.new_memory.attributes.media.image=e,this.render_model_data()},add_video_attachment:function(){var e=$("#video_text_input").val();this.new_memory.attributes.media.video=e,this.render_model_data()},validate_url:function(e){return/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)},validate_audio_url:function(e){return/soundcloud|bandcamp|youtube|\.(mp3|wav|ogg)$/i.test(e)},validate_image_url:function(e){return/imgur|\.(jpg|jpeg|gif|png)$/i.test(e)},validate_video_url:function(e){return/youtube|vimeo|vine|\.(mp4|mov|mkv|avi|m4v)$/i.test(e)},initialize_new_memory:function(){this.new_memory=new o({date:date,memory_text:"",media:{image:"",video:"",audio:""},emotions:{joy:{value:0,percentage:0},sadness:{value:0,percentage:0},anger:{value:0,percentage:0},fear:{value:0,percentage:0},disgust:{value:0,percentage:0},neutral:{value:0,percentage:0}},gradient:{"default":"",webkit:"",moz:""}})},save_memory:function(e){$(e.target).hasClass("enabled")&&(this.new_memory.emotion_vals_to_percentages(),this.new_memory.percentages_to_gradient_string(),s.add(this.new_memory),this.new_memory.save(),this.close(),this.clear())},reset:function(){this.initialize_new_memory(),this.render_model_data()}})),u=new m,c=Backbone.View.extend({el:$("#memory_display"),events:{"click #memory-display-close":"close_display","click .memory-delete-text":"delete_memory","click .memory-delete-cancel":"toggle_confirm","click .memory-display-delete .fa":"toggle_confirm","click .memory-toggle-audio":"toggle_audio"},visible:!1,initialize:function(){this.$media_text=$(".memory-audio-text"),this.audio_player=document.getElementById("memory-audio-player"),this.current_audio={artist:"",track:"",uri:""},this.close_display(),this.$el.removeClass("invisible")},render:function(e){var t=this;this.visible?this.render_callback(e):this.$el.animate({top:"72px"},850,"easeOutQuart",function(){t.visible=!0,t.render_callback(e)})},render_callback:function(e){this.reset_memory_display_state(),this.current_memory=e;var t=e.attributes.emotions;for(var i in t)t[i].percentage&&$(".segment-"+i).css("width",t[i].percentage+"%");$(".memory-display-controls > i").addClass("hide");var a=e.attributes.media;for(var r in a)if(a[r])switch(r){case"audio":$(".memory-display-controls > .fa-music").removeClass("hide");break;case"image":$(".memory-display-controls > .fa-picture-o").removeClass("hide");break;case"video":$(".memory-display-controls > .fa-video-camera").removeClass("hide")}this.$el.find(".memory-display-day").text(e.attributes.date_time.day),this.$el.find(".memory-display-time").text(e.attributes.date_time.time),this.$el.find(".memory-display-month").text(e.attributes.date_time.month),this.$el.find(".memory-display-date").text(e.attributes.date_time.date),this.$el.find(".memory-display-year").text(e.attributes.date_time.year),this.$el.find(".memory-display-text").text(e.attributes.memory_text),this.load_audio(e),this.load_image(e),this.load_video(e)},reset_memory_display_state:function(){this.set_audio_text(" "),this.reset_delete_confirm(),$(".emotions-meter-segment").css("width",0),this.$el.find(".memory-image-link").attr("href",""),this.$el.find(".memory-image-placeholder").attr("src","").addClass("hide"),this.$el.find(".memory-video-container").html("").addClass("hide"),this.$el.find(".memory-display-text").html("")},load_audio:function(e){var t=this,i=e.attributes.media.audio;if(i){var a="http://api.soundcloud.com/resolve.json?url="+i+"&client_id="+soundcloud_client_id;$.ajax({url:a,type:"get",success:function(e){var i=e.uri+"/stream?client_id="+soundcloud_client_id;t.current_audio.artist=e.user.username,t.current_audio.track=e.title,t.current_audio.uri=i,$("#memory-audio-player").attr("src",i)},error:function(e){console.log(e)}})}},play_audio:function(){this.audio_player.play()},toggle_audio:function(){this.audio_player.paused?(this.play_audio(),this.set_audio_text(this.current_audio.artist+" : "+this.current_audio.track)):this.audio_player.pause()},set_audio_text:function(e){this.$media_text.text(e)},load_image:function(e){var t=e.attributes.media.image;/\.(gif|jpg|jpeg|tiff|png)$/i.test(t)?($(".memory-image-placeholder").attr("src",t).removeClass("hide"),$(".memory-image-link").attr("href",t)):/imgur/i.test(t)?($(".memory-image-placeholder").attr("src",t+".jpg").removeClass("hide"),$(".memory-image-link").attr("href",t)):$(".memory-image-placeholder").addClass("hide")},load_video:function(e){var t=e.attributes.media.video;if(!t)return void this.$el.find(".memory-video-container").addClass("hide");if(this.$el.find(".memory-video-container").removeClass("hide"),/youtube/i.test(t)){var i=t.replace(/watch\?v=/,"embed/"),a='<iframe class="video-iframe" src="'+i+'" frameborder="0"></iframe>';this.$el.find(".memory-video-container").append(a)}else if(/vimeo/i.test(t)){var r=t.replace(/\D/g,""),o="https://player.vimeo.com/video/"+r,a='<iframe src="'+o+'" class="video-iframe" frameborder="0"></iframe>';this.$el.find(".memory-video-container").append(a)}},current_memory:"",close_display:function(){var e=this;this.audio_player.pause();var t=this.$el.height();this.$el.animate({top:"-"+t+"px"},850,"easeOutQuart",function(){e.visible=!1,$(".memory-active").removeClass("memory-active"),e.reset_memory_display_state()})},toggle_confirm:function(){$(".memory-delete-text").toggleClass("visible"),$(".delete-memory-icon").toggleClass("visible"),$(".memory-delete-cancel").toggleClass("visible")},reset_delete_confirm:function(){$(".memory-delete-text").removeClass("visible"),$(".delete-memory-icon").addClass("visible"),$(".memory-delete-cancel").removeClass("visible")},delete_memory:function(e){this.toggle_confirm(),this.current_memory.destroy(),this.close_display()}}),h=new c,v=Backbone.View.extend({tagName:"div",className:"memory",events:{click:"view_memory"},template:_.template($("#memory_template").html()),render:function(){return this.$el.html(this.template(this.model)),this.$el.attr("style","background: "+this.model.attributes.gradient["default"].toString()),this},remove_memory:function(){this.model.destroy(),this.remove()},view_memory:function(){this.$el.hasClass("memory-active")?h.close_display():($(".memory-active").removeClass("memory-active"),this.$el.addClass("memory-active"),h.render(this.model))}}),y=($("#memory_display"),$("#memories_num")),g=Backbone.View.extend({el:$("#memory_container"),events:{"click .sort_by_emotion":"sort_by_emotion"},initialize:function(){this.collection=s,this.render(),this.collection.on("add",this.render,this),this.collection.on("remove",this.render,this)},render:function(){return this.$el.html(""),this.collection.each(function(e){var t=new v({model:e});this.$el.append(t.render().el)},this),y.text(this.$el.children(".memory").length),this},delete_collection:function(){this.collection.each(function(e){e.destroy()}),this.render()},sort_by_emotion:function(e){this.collection.comparator=function(t,i){return t.get("emotions")[e].percentage<i.get("emotions")[e].percentage?-1:1},this.collection.sort(),this.render()},sort_by_date:function(e){"newest"===e?this.collection.comparator=function(e,t){return e.get("date_time").raw<t.get("date_time").raw?-1:1}:"oldest"===e&&(this.collection.comparator=function(e,t){return e.get("date_time").raw>t.get("date_time").raw?-1:1}),this.collection.sort(),this.render()},filter_by_emotion:function(t){if(this.collection.reset(l.toJSON()),"all"===t)return $("#memories_qty_label_prefix").text(""),void this.render();var i=this.collection.filter(function(e){return e.get("emotions")[t].value>0});$("#memories_qty_label_prefix").text(e(t,"adjective")),this.collection.reset(i),this.sort_by_emotion(t)}}),f=new g(s)}();